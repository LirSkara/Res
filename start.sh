#!/bin/bash

# QRes OS 4 - Start Server Script
# -----------------------------------------

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}==================================================${NC}"
echo -e "${GREEN}üçΩÔ∏è  QRes OS 4 - Restaurant Management System${NC}"
echo -e "${BLUE}==================================================${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Python 3 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")" || exit

echo -e "${BLUE}üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
if [[ "$1" == "--install" ]]; then
    echo -e "${YELLOW}üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
    pip3 install -r requirements.txt
    echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é${NC}"
fi

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo -e "${BLUE}üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
python3 -m alembic upgrade head

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞
PORT=${PORT:-8000}
LOG_LEVEL=${LOG_LEVEL:-info}
DEBUG=${DEBUG:-true}
RELOAD=${RELOAD:-true}

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ HOST —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ IP
if [ -z "$HOST" ]; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ IP 192.168.4.1 (–¥–ª—è Raspberry Pi)
    if ip addr show | grep -q "192.168.4.1"; then
        HOST="192.168.4.1"
        echo -e "${GREEN}‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π IP –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: $HOST${NC}"
    else
        # Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Mac/Linux)
        HOST="127.0.0.1"
        echo -e "${YELLOW}‚ö†Ô∏è  IP 192.168.4.1 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π: $HOST${NC}"
        echo -e "${BLUE}üí° –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ IP —Å–º. NETWORK_SETUP.md${NC}"
    fi
fi

echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ ${YELLOW}${HOST}:${PORT}${NC}"
echo -e "${BLUE}üìù –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: ${YELLOW}${LOG_LEVEL}${NC}"
echo -e "${BLUE}‚öôÔ∏è  –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: ${YELLOW}${DEBUG}${NC}"
echo -e "${BLUE}üîÑ –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞: ${YELLOW}${RELOAD}${NC}"
echo ""
echo -e "${GREEN}üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:${NC}"
echo -e "   ${YELLOW}http://${HOST}:${PORT}/docs${NC}"
echo -e "   ${YELLOW}http://${HOST}:${PORT}/redoc${NC}"
echo ""
echo -e "${BLUE}==================================================${NC}"
echo -e "${GREEN}üí° –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞${NC}"
echo -e "${BLUE}==================================================${NC}"

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
if [ "$RELOAD" = "true" ]; then
    RELOAD_FLAG="--reload"
else
    RELOAD_FLAG=""
fi

python3 -m uvicorn app.main:app --host $HOST --port $PORT --log-level $LOG_LEVEL $RELOAD_FLAG
