#!/bin/bash

# QRes OS 4 - Stop Server Script
# -----------------------------------------

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}==================================================${NC}"
echo -e "${RED}üõë QRes OS 4 - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞${NC}"
echo -e "${BLUE}==================================================${NC}"
echo ""

# –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å uvicorn
PID=$(pgrep -f "uvicorn app.main:app")

if [ -z "$PID" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –°–µ—Ä–≤–µ—Ä QRes OS 4 –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
    exit 0
fi

echo -e "${BLUE}üîç –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å–µ—Ä–≤–µ—Ä–∞ —Å PID: ${YELLOW}$PID${NC}"
echo -e "${BLUE}üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...${NC}"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
kill -15 "$PID"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
sleep 2
if ps -p "$PID" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...${NC}"
    kill -9 "$PID"
    sleep 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
if ! ps -p "$PID" > /dev/null; then
    echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä${NC}"
    exit 1
fi

echo -e "${BLUE}==================================================${NC}"
