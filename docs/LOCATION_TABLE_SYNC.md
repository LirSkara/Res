# Система синхронизации статусов локаций и столиков

## Обзор

Реализована профессиональная система автоматической синхронизации статусов между локациями и столиками, которая обеспечивает целостность данных и предотвращает бизнес-логические ошибки.

## Основные принципы

### 1. Каскадная деактивация
- При деактивации локации автоматически деактивируются все столики в ней
- Сбрасывается статус занятости всех столиков
- Сбрасываются активные заказы (с предупреждением)

### 2. Защита от некорректных состояний
- Нельзя создать активный столик в неактивной локации
- Нельзя активировать столик в неактивной локации
- Нельзя изменить статус столика в неактивной локации
- Активные столики должны быть привязаны к локации

### 3. Проверка перед деактивацией
- Перед деактивацией локации проверяется наличие активных заказов
- Если есть активные заказы, деактивация блокируется

## Новые API эндпоинты

### Локации

#### `PATCH /locations/{location_id}/sync-tables`
Принудительная синхронизация столиков с локацией.

**Параметры:**
- `force_activation` (bool): Принудительно активировать столики при активной локации

**Пример ответа:**
```json
{
  "message": "Синхронизированы столики в локации 'Основной зал'. Изменено столиков: 5"
}
```

#### `GET /locations/admin/integrity-check`
Проверка целостности данных (только для администраторов).

**Пример ответа:**
```json
{
  "issues_found": true,
  "locations": {"total": 3, "active": 2, "inactive": 1},
  "tables": {"total": 15, "active": 12, "inactive": 3, "without_location": 1},
  "integrity_issues": [
    {
      "type": "active_table_inactive_location",
      "table_id": 5,
      "table_number": 10,
      "description": "Столик 10 активен в неактивной локации 'Терраса'"
    }
  ],
  "recommendations": [
    "Деактивировать 2 столика в неактивных локациях"
  ]
}
```

#### `POST /locations/admin/auto-fix`
Автоматическое исправление проблем целостности.

**Параметры:**
- `dry_run` (bool): Предварительный просмотр без применения изменений
- `fix_types` (List[str]): Типы проблем для исправления

**Типы проблем:**
- `active_table_inactive_location` - Активный столик в неактивной локации
- `active_table_no_location` - Активный столик без локации
- `occupied_inactive_table` - Занятый неактивный столик
- `order_at_inactive_table` - Заказ у неактивного столика

### Столики

#### `GET /tables/{table_id}/sync-status`
Проверка статуса синхронизации столика с локацией.

**Пример ответа:**
```json
{
  "table_id": 5,
  "table_number": 10,
  "table_is_active": true,
  "location_id": 2,
  "location_name": "Терраса",
  "location_is_active": false,
  "is_synchronized": false,
  "sync_issues": [
    "Столик активен, но находится в неактивной локации"
  ]
}
```

#### `PATCH /tables/{table_id}/force-sync`
Принудительная синхронизация столика с локацией (только для администраторов).

## Сервисные функции

### `sync_tables_with_location_status()`
Основная функция синхронизации столиков с локацией.

**Особенности:**
- Логирование всех изменений
- Возврат списка ID измененных столиков
- Поддержка принудительной синхронизации

### `check_location_has_active_orders()`
Проверка наличия активных заказов в локации.

### `bulk_update_tables_status()`
Массовое обновление статуса столиков через SQL.

### `check_data_integrity()`
Комплексная проверка целостности данных.

### `auto_fix_integrity_issues()`
Автоматическое исправление проблем с поддержкой dry-run режима.

## Логирование

Все операции синхронизации логируются:
- Деактивация столиков при деактивации локации
- Освобождение столиков
- Сброс активных заказов (с предупреждением)
- Массовые операции
- Результаты проверок целостности

## Использование

### Сценарий 1: Деактивация локации
```python
# При обновлении локации система автоматически:
# 1. Проверит наличие активных заказов
# 2. Если заказов нет - деактивирует все столики
# 3. Сбросит статус занятости
# 4. Залогирует все изменения
```

### Сценарий 2: Проверка целостности
```python
# Администратор может:
# 1. Проверить целостность данных
# 2. Получить детальный отчет о проблемах
# 3. Применить автоисправления
# 4. Проверить результат
```

### Сценарий 3: Синхронизация столика
```python
# При создании/обновлении столика:
# 1. Проверяется статус локации
# 2. Блокируется создание активного столика в неактивной локации
# 3. При необходимости столик синхронизируется принудительно
```

## Преимущества реализации

1. **Целостность данных**: Исключены некорректные состояния
2. **Автоматизация**: Минимум ручных операций
3. **Безопасность**: Проверки перед критическими операциями
4. **Прозрачность**: Детальное логирование всех изменений
5. **Гибкость**: Возможность принудительной синхронизации
6. **Диагностика**: Инструменты для проверки и исправления проблем
7. **Производительность**: Массовые операции через SQL
8. **Надежность**: Dry-run режим для безопасного тестирования

## Рекомендации по использованию

1. Регулярно проверяйте целостность данных через `/admin/integrity-check`
2. При больших изменениях используйте dry-run режим
3. Мониторьте логи для отслеживания автоматических изменений
4. При проблемах используйте принудительную синхронизацию
5. Всегда проверяйте статус перед деактивацией локаций с заказами
